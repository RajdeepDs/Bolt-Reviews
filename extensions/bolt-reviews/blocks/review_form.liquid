{% comment %}
  Review Form Block
  Allows customers to write and submit reviews for products
{% endcomment %}

<div class="review-form-wrapper" data-product-id="{{ product.id }}">
  <div class="review-form-header">
    <h3>Write a Review</h3>
    <p>Share your thoughts with other customers</p>
  </div>

  <form id="review-form" class="review-form">
    <div class="form-group">
      <label for="review-rating" class="required">Rating</label>
      <div class="star-rating-input" id="star-rating-input">
        <input type="radio" name="rating" id="star5" value="5" required>
        <label for="star5" class="star-label" data-rating="5">★</label>

        <input type="radio" name="rating" id="star4" value="4">
        <label for="star4" class="star-label" data-rating="4">★</label>

        <input type="radio" name="rating" id="star3" value="3">
        <label for="star3" class="star-label" data-rating="3">★</label>

        <input type="radio" name="rating" id="star2" value="2">
        <label for="star2" class="star-label" data-rating="2">★</label>

        <input type="radio" name="rating" id="star1" value="1">
        <label for="star1" class="star-label" data-rating="1">★</label>
      </div>
      <span class="rating-text" id="rating-text"></span>
    </div>

    <div class="form-group">
      <label for="review-title" class="required">Review Title</label>
      <input
        type="text"
        id="review-title"
        name="title"
        required
        maxlength="100"
        placeholder="Sum up your review in one line"
      >
    </div>

    <div class="form-group">
      <label for="review-content" class="required">Review</label>
      <textarea
        id="review-content"
        name="content"
        required
        rows="5"
        maxlength="1000"
        placeholder="Tell us what you think about this product..."
      ></textarea>
      <span class="char-count" id="char-count">0/1000</span>
    </div>

    <div class="form-group">
      <label for="customer-name" class="required">Your Name</label>
      <input
        type="text"
        id="customer-name"
        name="customerName"
        required
        maxlength="100"
        placeholder="Enter your name"
      >
    </div>

    {% if block.settings.show_email_field %}
    <div class="form-group">
      <label for="customer-email" class="required">Email</label>
      <input
        type="email"
        id="customer-email"
        name="customerEmail"
        required
        placeholder="your.email@example.com"
      >
      <span class="field-note">Your email will not be published</span>
    </div>
    {% endif %}

    <div class="form-group">
      <label for="review-photos">
        Photos {% if block.settings.require_photo %}<span class="required-marker">*</span>{% endif %}
      </label>
      <div class="photo-upload-area" id="photo-upload-area">
        <input
          type="file"
          id="review-photos"
          name="photos"
          accept="image/*"
          multiple
          {% if block.settings.require_photo %}required{% endif %}
        >
        <label for="review-photos" class="upload-label">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            <circle cx="8.5" cy="8.5" r="1.5"></circle>
            <polyline points="21 15 16 10 5 21"></polyline>
          </svg>
          <span>Click to upload photos or drag and drop</span>
          <span class="upload-note">PNG, JPG up to 5MB (Max 5 photos)</span>
        </label>
      </div>
      <div class="photo-preview" id="photo-preview"></div>
    </div>

    <div class="form-group checkbox-group">
      <label class="checkbox-label">
        <input type="checkbox" name="verified" id="verified-purchase">
        <span>I purchased this product</span>
      </label>
    </div>

    <div class="form-actions">
      <button type="submit" class="btn-submit" id="submit-btn">
        Submit Review
      </button>
      <button type="button" class="btn-cancel" id="cancel-btn">
        Cancel
      </button>
    </div>

    <div class="form-message" id="form-message" style="display: none;"></div>
  </form>
</div>

<style>
  .review-form-wrapper {
    max-width: 600px;
    margin: 2rem auto;
    padding: 2rem;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .review-form-header {
    text-align: center;
    margin-bottom: 2rem;
  }

  .review-form-header h3 {
    font-size: 1.5rem;
    font-weight: 600;
    margin: 0 0 0.5rem 0;
    color: #222;
  }

  .review-form-header p {
    font-size: 0.9375rem;
    color: #666;
    margin: 0;
  }

  .review-form {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .form-group label {
    font-size: 0.9375rem;
    font-weight: 600;
    color: #333;
  }

  .required::after,
  .required-marker {
    content: " *";
    color: #f44336;
  }

  .star-rating-input {
    display: flex;
    flex-direction: row-reverse;
    justify-content: flex-end;
    gap: 0.25rem;
  }

  .star-rating-input input[type="radio"] {
    display: none;
  }

  .star-label {
    font-size: 2rem;
    color: #e0e0e0;
    cursor: pointer;
    transition: color 0.2s;
  }

  .star-rating-input input[type="radio"]:checked ~ .star-label,
  .star-rating-input:hover input[type="radio"]:checked ~ .star-label {
    color: #FFB800;
  }

  .star-rating-input .star-label:hover,
  .star-rating-input .star-label:hover ~ .star-label {
    color: #FFB800;
  }

  .rating-text {
    font-size: 0.875rem;
    color: #666;
    font-weight: 500;
  }

  .form-group input[type="text"],
  .form-group input[type="email"],
  .form-group textarea {
    padding: 0.75rem;
    border: 1px solid #d0d0d0;
    border-radius: 4px;
    font-size: 0.9375rem;
    font-family: inherit;
    transition: border-color 0.2s;
  }

  .form-group input[type="text"]:focus,
  .form-group input[type="email"]:focus,
  .form-group textarea:focus {
    outline: none;
    border-color: #333;
  }

  .form-group textarea {
    resize: vertical;
    min-height: 120px;
  }

  .char-count {
    font-size: 0.75rem;
    color: #999;
    text-align: right;
  }

  .field-note {
    font-size: 0.75rem;
    color: #999;
    font-style: italic;
  }

  .photo-upload-area {
    position: relative;
  }

  .photo-upload-area input[type="file"] {
    position: absolute;
    width: 0;
    height: 0;
    opacity: 0;
  }

  .upload-label {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 2rem;
    border: 2px dashed #d0d0d0;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
    gap: 0.5rem;
  }

  .upload-label:hover {
    border-color: #333;
    background: #f9f9f9;
  }

  .upload-label svg {
    color: #999;
  }

  .upload-label span {
    display: block;
    font-size: 0.9375rem;
    color: #666;
  }

  .upload-note {
    font-size: 0.75rem !important;
    color: #999 !important;
  }

  .photo-preview {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    gap: 0.5rem;
    margin-top: 1rem;
  }

  .preview-item {
    position: relative;
    aspect-ratio: 1;
    border-radius: 8px;
    overflow: hidden;
  }

  .preview-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .preview-remove {
    position: absolute;
    top: 0.25rem;
    right: 0.25rem;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: rgba(0, 0, 0, 0.7);
    color: #fff;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    transition: background 0.2s;
  }

  .preview-remove:hover {
    background: rgba(0, 0, 0, 0.9);
  }

  .checkbox-group {
    flex-direction: row;
  }

  .checkbox-label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 400 !important;
    cursor: pointer;
  }

  .checkbox-label input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
  }

  .form-actions {
    display: flex;
    gap: 1rem;
    margin-top: 1rem;
  }

  .btn-submit,
  .btn-cancel {
    flex: 1;
    padding: 0.875rem 1.5rem;
    border: none;
    border-radius: 4px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-submit {
    background: #333;
    color: #fff;
  }

  .btn-submit:hover:not(:disabled) {
    background: #000;
  }

  .btn-submit:disabled {
    background: #ccc;
    cursor: not-allowed;
  }

  .btn-cancel {
    background: #fff;
    color: #333;
    border: 1px solid #d0d0d0;
  }

  .btn-cancel:hover {
    background: #f5f5f5;
  }

  .form-message {
    padding: 1rem;
    border-radius: 4px;
    text-align: center;
    font-size: 0.9375rem;
    font-weight: 500;
  }

  .form-message.success {
    background: #e8f5e9;
    color: #2e7d32;
    border: 1px solid #4caf50;
  }

  .form-message.error {
    background: #ffebee;
    color: #c62828;
    border: 1px solid #f44336;
  }

  @media (max-width: 768px) {
    .review-form-wrapper {
      padding: 1rem;
      margin: 1rem;
    }

    .form-actions {
      flex-direction: column;
    }

    .star-label {
      font-size: 1.75rem;
    }
  }
</style>

<script>
  (function() {
    const form = document.getElementById('review-form');
    const productId = document.querySelector('[data-product-id]')?.dataset.productId;
    const starInputs = document.querySelectorAll('.star-rating-input input[type="radio"]');
    const ratingText = document.getElementById('rating-text');
    const charCount = document.getElementById('char-count');
    const contentTextarea = document.getElementById('review-content');
    const photoInput = document.getElementById('review-photos');
    const photoPreview = document.getElementById('photo-preview');
    const submitBtn = document.getElementById('submit-btn');
    const cancelBtn = document.getElementById('cancel-btn');
    const formMessage = document.getElementById('form-message');

    const ratingTexts = {
      1: 'Poor',
      2: 'Fair',
      3: 'Good',
      4: 'Very Good',
      5: 'Excellent'
    };

    let selectedFiles = [];

    // Star rating interaction
    starInputs.forEach(input => {
      input.addEventListener('change', (e) => {
        const rating = e.target.value;
        ratingText.textContent = ratingTexts[rating];
      });
    });

    // Character count for textarea
    contentTextarea?.addEventListener('input', (e) => {
      const length = e.target.value.length;
      charCount.textContent = `${length}/1000`;
    });

    // Photo upload handling
    photoInput?.addEventListener('change', handleFileSelect);

    function handleFileSelect(e) {
      const files = Array.from(e.target.files);

      if (files.length > 5) {
        showMessage('You can only upload up to 5 photos', 'error');
        return;
      }

      selectedFiles = files;
      displayPhotoPreviews(files);
    }

    function displayPhotoPreviews(files) {
      photoPreview.innerHTML = '';

      files.forEach((file, index) => {
        if (file.size > 5 * 1024 * 1024) {
          showMessage(`${file.name} is too large. Maximum size is 5MB`, 'error');
          return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
          const previewItem = document.createElement('div');
          previewItem.className = 'preview-item';
          previewItem.innerHTML = `
            <img src="${e.target.result}" alt="Preview ${index + 1}">
            <button type="button" class="preview-remove" data-index="${index}">×</button>
          `;

          previewItem.querySelector('.preview-remove').addEventListener('click', () => {
            removePhoto(index);
          });

          photoPreview.appendChild(previewItem);
        };
        reader.readAsDataURL(file);
      });
    }

    function removePhoto(index) {
      selectedFiles.splice(index, 1);
      displayPhotoPreviews(selectedFiles);

      // Update file input
      const dataTransfer = new DataTransfer();
      selectedFiles.forEach(file => dataTransfer.items.add(file));
      photoInput.files = dataTransfer.files;
    }

    // Form submission
    form?.addEventListener('submit', async (e) => {
      e.preventDefault();

      if (!productId) {
        showMessage('Product ID is missing', 'error');
        return;
      }

      submitBtn.disabled = true;
      submitBtn.textContent = 'Submitting...';

      try {
        const formData = new FormData();
        formData.append('productId', productId);
        formData.append('rating', form.rating.value);
        formData.append('title', form.title.value);
        formData.append('content', form.content.value);
        formData.append('customerName', form.customerName.value);

        if (form.customerEmail) {
          formData.append('customerEmail', form.customerEmail.value);
        }

        if (form.verified.checked) {
          formData.append('verified', 'true');
        }

        selectedFiles.forEach((file, index) => {
          formData.append(`photo${index}`, file);
        });

        const response = await fetch('/apps/bolt-reviews/api/reviews', {
          method: 'POST',
          body: formData
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.message || 'Failed to submit review');
        }

        showMessage('Thank you! Your review has been submitted successfully.', 'success');
        form.reset();
        photoPreview.innerHTML = '';
        selectedFiles = [];
        ratingText.textContent = '';
        charCount.textContent = '0/1000';

        // Reload reviews list after 2 seconds
        setTimeout(() => {
          window.location.reload();
        }, 2000);

      } catch (error) {
        console.error('Error submitting review:', error);
        showMessage(error.message || 'Failed to submit review. Please try again.', 'error');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit Review';
      }
    });

    // Cancel button
    cancelBtn?.addEventListener('click', () => {
      form.reset();
      photoPreview.innerHTML = '';
      selectedFiles = [];
      ratingText.textContent = '';
      charCount.textContent = '0/1000';
      formMessage.style.display = 'none';
    });

    function showMessage(message, type) {
      formMessage.textContent = message;
      formMessage.className = `form-message ${type}`;
      formMessage.style.display = 'block';

      setTimeout(() => {
        formMessage.style.display = 'none';
      }, 5000);
    }

    // Drag and drop for photos
    const uploadArea = document.getElementById('photo-upload-area');

    uploadArea?.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.querySelector('.upload-label').style.borderColor = '#333';
      uploadArea.querySelector('.upload-label').style.background = '#f9f9f9';
    });

    uploadArea?.addEventListener('dragleave', (e) => {
      e.preventDefault();
      uploadArea.querySelector('.upload-label').style.borderColor = '#d0d0d0';
      uploadArea.querySelector('.upload-label').style.background = 'transparent';
    });

    uploadArea?.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.querySelector('.upload-label').style.borderColor = '#d0d0d0';
      uploadArea.querySelector('.upload-label').style.background = 'transparent';

      const files = Array.from(e.dataTransfer.files).filter(file => file.type.startsWith('image/'));

      if (files.length > 0) {
        const dataTransfer = new DataTransfer();
        files.forEach(file => dataTransfer.items.add(file));
        photoInput.files = dataTransfer.files;

        handleFileSelect({ target: { files: dataTransfer.files } });
      }
    });
  })();
</script>

{% schema %}
{
  "name": "Write Review Form",
  "target": "section",
  "settings": [
    {
      "type": "checkbox",
      "id": "require_photo",
      "label": "Require photo upload",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "show_email_field",
      "label": "Show email field",
      "default": true
    }
  ]
}
{% endschema %}
